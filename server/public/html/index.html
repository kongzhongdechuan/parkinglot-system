<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>车位检测系统</title>

</head>

<body>
    <div id="container" style="width: 1370px;">
        <div id="header" style="background-color:#80f7f3;">
            <h1 style="margin-bottom:0;text-align: center;">车位检测系统</h1>
        </div>

        <div id="content" style="background-color:#97dbee;height:600px;width:1100px;float:left;">
            <div style="background-color: #5f818b;height: 80px;overflow: hidden;">
                <!--在style中加入overflow：hidden,否则会移动div-->
                <!--<h2> 信息显示区域</h2>-->
                <div style="width: 800px;float: left;">
                    <p id="data_display_area"></p>
                </div>

                <div style="background-color:olivedrab; width: 300px; height:600px;float : right;">
                    <p id="parknum_display_area"></p>
                </div>
            </div>

            <div style="height: 520px;">
                <!--<img id="parking-lot" src="D:\\桌面\\小毕设\\具体实现\\前端\\image\\parking.jpg">-->
                <canvas id="drawing-canvas" width="1100px" height="520px" background-color="#FF0000">
                    浏览器不支持HTML5 canvas 标签
                </canvas>
                <script>

                    const myImg = new Image();
                    myImg.src = 'images/parking.jpg';

                    var canvas = document.getElementById('drawing-canvas');
                    var context = canvas.getContext('2d');
                    context.strokeStyle = 'red';
                    context.lineWidth = 7;
                    myImg.onload = function () {
                        console.log(this);
                        context.drawImage(this, 0, 0);
                    }

                    // 将图片对象保存在全局变量中
                    window.myImg = myImg;
                    window.context = context;
                </script>



            </div>
        </div>


        <div id="menu" style="background-color:#5afaba;text-align:center;height:600px;width:270px;float:left;">
            <div style="height: 40px;">
                <div style="height: 10px;"></div>
                <b>菜单</b>
            </div>
            <div style="height: 240px;">

                <form id="submit_form" method="post" enctype="multipart/form-data">
                    <input type="file" id="image-input" name="car-image" accept="image/*"><br>
                    <!---<input type="submit" value="upload Picture" float="left">--->
                    <!--图片的默认大小为高度为:195像素,宽度为:260像素。使用之前先用python修改一下-->
                    <img id="image-preview" src="">

                </form>

            </div>

            <div style="height: 150px;">
                <button id="zero-button" style="height: 25px;width: 200px;">初始化</button><br>
                <button id="random-button" style="height: 25px;width: 200px;">随机初始化</button><br>
                <button id="full-button" style="height: 25px;width: 200px;">满车位</button><br>
                <button id="autoEnter-button" style="height: 25px;width: 200px;">自动测试</button><br>
            </div>


            <button id="enter-button" style="height: 50px;width: 200px;">车辆进入</button><br>
            <div style="height: 40px;"></div>
            <button id="exit-button" style="height: 50px;width: 200px;">车辆驶出</button><br>
        </div>


    </div>


    <script>
        //页面初始化的操作
        window.onload = function () {
            // 发起 AJAX 请求，从后端获取数据

            show_alreadyParking_Func();

            show_parklot_number();
        };


        //车辆初始化操作
        function show_parklot_number() {
            return fetch('/get_parkinglot_number', {
                method: 'POST',
            })
                .then(response => response.json())
                .then(data => {
                    var parkinglotNumber = data.parkinglotNumber;
                    var p = document.createElement('p');
                    p.textContent = `剩余车位数: ${parkinglotNumber}`;

                    ParkNumberDisplay.innerHTML = '';
                    ParkNumberDisplay.appendChild(p);
                    console.log('执行get_parkinglot_Number');
                    return parkinglotNumber;
                })
                .catch(error => {
                    console.error('展示车位数失败:', error);

                    ParkNumberDisplay.textContent = '展示车位失败';
                    throw error;
                });
        }

        //车辆进入的一些函数操作——————————————————————————————————————————————————————————————————
        //车辆进入，显示车牌
        function car_enter_Func(formData) {
            return fetch('/car_enter', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    var carNumber = data.carNumber;
                    var p = document.createElement('p');
                    p.textContent = `欢迎您！ 尊贵的 ${carNumber} 的车主。我已为您规划好车位，车位路线如下！`;
                    dataDisplay.innerHTML = '';
                    dataDisplay.appendChild(p);
                    return formData;
                })
                .catch(error => {
                    console.error('获取数据失败:', error);
                    dataDisplay.textContent = '获取车牌号失败';
                    throw error;
                });
        }

        //展示车位信息
        function show_alreadyParking_Func(formData) {
            return fetch('/show_alreadyParking')
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error('获取坐标请求失败');
                    }
                })
                .then(coordinates => {
                    context.strokeStyle = 'brown';
                    coordinates.forEach(coordinate => {
                        context.beginPath();
                        context.moveTo(coordinate.x1, coordinate.y1);
                        context.lineTo(coordinate.x2, coordinate.y2);
                        context.stroke();
                    });
                    return formData;
                })
                .catch(error => {
                    console.error('错误:', error);
                    throw error;
                });
        }



        //展示要去的车位

        function show_willPark_Func(formData) {
            return fetch('/get_willParkinglot', {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error('获取坐标请求失败');
                    }
                })
                .then(coordinates => {
                    context.strokeStyle = 'green';
                    coordinates.forEach(coordinate => {
                        context.beginPath();
                        context.moveTo(coordinate.x1, coordinate.y1);
                        context.lineTo(coordinate.x2, coordinate.y2);
                        context.stroke();
                    });
                    return formData;
                })
                .catch(error => {
                    console.error('错误:', error);
                    throw error;
                });
        }

        //展示路径信息
        function get_coordinates_Func(formData) {
            return fetch('/get_coordinates', {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error('获取坐标请求失败');
                    }
                })
                .then(coordinates => {


                    //添加绘制从大门到（12,0）的路径
                    context.strokeStyle = 'red';
                    context.beginPath();

                    context.moveTo(10, 251);
                    context.lineTo(41.25, 251.875);
                    context.stroke();

                    coordinates.forEach(coordinate => {
                        context.beginPath();
                        context.moveTo(coordinate.x1, coordinate.y1);
                        context.lineTo(coordinate.x2, coordinate.y2);
                        context.stroke();
                    });
                })
                .catch(error => {
                    console.error('错误:', error);
                    throw error;
                });
        }




        //车辆进入的总函数，先看是否还有车位，之后再根据车位数进行操作
        function ParkingNumber_CarEnter(formData) {
            show_parklot_number()
                .then(parkinglotNumber => {
                    console.log('车位数:', parkinglotNumber);

                    if (parkinglotNumber >= 1) {
                        car_enter_Func(formData)
                            .then(show_alreadyParking_Func)
                            .then(show_willPark_Func)
                            .then(get_coordinates_Func)
                            .then(show_parklot_number)
                            .catch(error => {
                                console.error('处理错误:', error);
                            });
                    } else {
                        var dataMsg = '尊敬的车主，很抱歉已经没有车位！';
                        // 假设 dataDisplay 在你的 HTML 中有定义
                        dataDisplay.textContent = dataMsg;
                        show_alreadyParking_Func();
                    }
                })
                .catch(error => {
                    console.error('获取车位数失败:', error);
                });
        }







        //车辆驶出的一些操作————————————————————————————————————————————————————————
        // 车辆驶出，获取车牌号和车费
        function car_exit_Func(formData) {
            return fetch('/car_exit', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    var dataMsg = `感谢您的光临！ 尊贵的 ${data.carNumber} 的车主。您的车费为: ${data.parkCost} 元!`
                    dataDisplay.textContent = dataMsg;
                    return formData; // 将formData传递给下一个函数
                })
                .catch(error => {
                    console.error('Failed to fetch data:', error);
                    dataDisplay.textContent = 'Failed to fetch car number';
                    throw error;
                });
        }

        // 展示已经停车的车位
        function show_exitParking_Func(formData) {
            return fetch('/car_exit_Database', {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error('获取坐标请求失败');
                    }
                })
                .then(coordinates => {
                    context.strokeStyle = 'brown';
                    coordinates.forEach(coordinate => {
                        context.beginPath();
                        context.moveTo(coordinate.x1, coordinate.y1);
                        context.lineTo(coordinate.x2, coordinate.y2);
                        context.stroke();
                    });
                })
                .catch(error => {
                    console.error('错误:', error);
                    throw error;
                });
        }


        //测试的方法--------------------------------------------------------------
        async function zeroInit_Func() {
            try {
                fetch('/zero_init', {
                    method: 'POST',
                });
            } catch (error) {
                console.error('Failed to use func:', error);
                throw error;
            }
        }

        async function fullInit_Func() {
            try {
                fetch('/full_init', {
                    method: 'POST',
                });
            } catch (error) {
                console.error('Failed to use func:', error);
                throw error;
            }
        }

        async function randomInit_Func() {
            try {
                await fetch('/random_init', {
                    method: 'POST',
                });
            } catch (error) {
                console.error('Failed to use func:', error);
                throw error;
            }
        }


    </script>






    <script>
        // 获取页面元素
        const imageInput = document.getElementById('image-input');
        const processImageBtn = document.getElementById('process-image');
        const imagePreview = document.getElementById('image-preview');
        const outputImage = document.getElementById('output-image');

        // 监听图片上传事件
        imageInput.addEventListener('change', function () {
            const file = imageInput.files[0];
            if (file) {
                const imageUrl = URL.createObjectURL(file);
                imagePreview.src = imageUrl;
            }
        });


        const enterButton = document.getElementById('enter-button');
        const form = document.querySelector('#submit_form');
        const dataDisplay = document.getElementById('data_display_area');
        const ParkNumberDisplay = document.getElementById('parknum_display_area');
        const exitButton = document.getElementById('exit-button');
        enterButton.addEventListener('click', function () {

            const formData = new FormData();
            formData.append('car-image', document.getElementById('image-input').files[0]);


            const myImg = window.myImg;
            const context = window.context;
            context.strokeStyle = 'red';

            // 清空画布
            context.clearRect(0, 0, canvas.width, canvas.height);

            // 绘制图片
            context.drawImage(myImg, 0, 0);


            ParkingNumber_CarEnter(formData);



        });

        //点击动作
        exitButton.addEventListener('click', function () {
            //显示图片

            //获取img和context
            const myImg = window.myImg;
            const context = window.context;

            // 清空画布
            context.clearRect(0, 0, canvas.width, canvas.height);

            // 绘制图片
            context.drawImage(myImg, 0, 0);


            const formData = new FormData();
            formData.append('car-image', document.getElementById('image-input').files[0]);


            //车辆驶出功能
            car_exit_Func(formData)
                .then(show_exitParking_Func)
                .then(show_parklot_number)
                .catch(error => {
                    console.error('处理错误:', error);
                });

        });





        //添加一些测试按钮  ---------------------------------------------------------------------
        const zeroButton = document.getElementById('zero-button');
        const randomButton = document.getElementById('random-button');
        const fullButton = document.getElementById('full-button');
        const autoEnterButton = document.getElementById('autoEnter-button');

        zeroButton.addEventListener('click',async function () {
            try {
                await zeroInit_Func();
                location.reload();
            } catch (error) {
                console.error('Failed to use func:', error);
            }

        });

        fullButton.addEventListener('click',async function () {
            try {
                await fullInit_Func();
                location.reload();
            } catch (error) {
                console.error('Failed to use func:', error);
            }
        });

        randomButton.addEventListener('click', async function () {
            try {
                await randomInit_Func();
                location.reload();
            } catch (error) {
                console.error('Failed to use func:', error);
            }
        });


    </script>



</body>

</html>